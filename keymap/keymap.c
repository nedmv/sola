#include QMK_KEYBOARD_H
#include <stdio.h>
#include "print.h"


#define CUSTOM_SAFE_RANGE SAFE_RANGE
#include "../lang_shift/include.h"

#include "layers.h"
#include "oled.c"
#include "encoder.c"
#include "rgb.c"
#include "dance.c"

#define CASH(KC)  LALT(LCTL(LSFT(KC))) // MEH does not work as expected

enum custom_keycodes {
    CANCEL = CUSTOM_SAFE_RANGE, // TO L_RU, if it's active. Else TO L_EN.
    LOCK, // Lock screen and move to layer 0.
    MDASH_SP, // MDASH with space

    CUSTOM_KEYCODES_SAFE_RANGE,
    #undef CUSTOM_SAFE_RANGE
    #define CUSTOM_SAFE_RANGE CUSTOM_KEYCODES_SAFE_RANGE
};

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
/*
 * EN (base)
 * .-----------------------------------------.                    .-----------------------------------------.
 * | ESC  |  1   |  2   |  3   |  4   |  5   |                    |  6   |  7   |  8   |  9   |  0   |  -   |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * | PROG1|  q   |  w   |  e   |  r   |  t   |                    |  y   |  u   |  i   |  o   |  p   |      |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * | ,+SPC|  a   |  s   |  d   |  f   |  g   |-------.    .-------|  h   |  j   |  k   |  l   |      |  '   |
 * |------+------+------+------+------+------| HOME  |    | END   |------+------+------+------+------+------|
 * | LANG |  z   |  x   |  c   |  v   |  b   |-------|    |-------|  n   |  m   |  '   |      |  .   |  /   |
 * '-----------------------------------------/      /      \       \----------------------------------------'
 *            | WIN  | ALT  | CTRL | SPACE| /BSPACE/        \ ENTER \ | SHIFT| MOVE | TAB  | KEEB |
 *            '------+------+------+------+------/           \--------+------+------+------+------'
 */
  [L_EN] = LAYOUT(
  //,------------------------------------------------.                    ,---------------------------------------------------.
  KC_ESC,   AG_1,   AG_2,    AG_3,    AG_4,    AG_5,                       AG_6,    AG_7,   AG_8,    AG_9,    AG_0,    AG_MINS,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  OSL(L_PROG),EN_Q, EN_W,    EN_E,    EN_R,    EN_T,                       EN_Y,    EN_U,   EN_I,    EN_O,    EN_P,    XXXXXXX,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  AG_CMSP,  EN_A,   EN_S,    EN_D,    EN_F,    EN_G,                       EN_H,    EN_J,   EN_K,    EN_L,    XXXXXXX, EN_QUOT,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
  LA_CHNG,  EN_Z,   EN_X,    EN_C,    EN_V,    EN_B,  KC_HOME,    KC_END, EN_N,    EN_M,   EN_QUOT, XXXXXXX, AG_DOT,  AG_SLSH,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
                  WIN_0,   ALT_0,   CTRL_0,  KC_SPC,  KC_BSPC,    KC_ENTER,SFT_N,TT(L_MOVE),  KC_TAB,TT(L_KEEB)
  //            \--------+--------+--------+---------+-------|   |--------+---------+--------+---------+-------/
),
/*
 * EN (shifted)
 * .-----------------------------------------.                    .-----------------------------------------.
 * | ESC  |  !   |  "   |  #   |  $   |  %   |                    |  ^   |  ?   |  *   |  &   |  @   |  _   |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * | PROG1|  Q   |  W   |  E   |  R   |  T   |                    |  Y   |  U   |  I   |  O   |  P   |      |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * |  ;   |  A   |  S   |  D   |  F   |  G   |-------.    .-------|  H   |  J   |  K   |  L   |      |  "   |
 * |------+------+------+------+------+------| HOME  |    | END   |------+------+------+------+------+------|
 * | LANG |  Z   |  X   |  C   |  V   |  B   |-------|    |-------|  N   |  M   |  '   |      |  :   |  \   |
 * '-----------------------------------------/      /      \       \----------------------------------------'
 *            | WIN  | ALT  | CTRL | SPACE| /BSPACE/        \ ENTER \ | SHIFT| MOVE | TAB  | KEEB |
 *            '------+------+------+------+------/           \--------+------+------+------+------'
 */
  [L_EN_S] = LAYOUT(
  //,------------------------------------------------.                    ,---------------------------------------------------.
  _______, AG_EXCL, AG_DQUO, EN_HASH,  EN_DLR, AG_PERC,                    EN_CIRC,AG_QUES,AG_ASTR, EN_AMPR, EN_AT,  AG_UNDS,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  _______, EN_S_Q, EN_S_W,   EN_S_E,   EN_S_R, EN_S_T,                     EN_S_Y, EN_S_U,  EN_S_I, EN_S_O,  EN_S_P, XXXXXXX,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  AG_SCLN, EN_S_A, EN_S_S,   EN_S_D,   EN_S_F, EN_S_G,                     EN_S_H, EN_S_J, EN_S_K,  EN_S_L,  XXXXXXX, AG_DQUO,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
  _______, EN_S_Z, EN_S_X,   EN_S_C,   EN_S_V, EN_S_B,_______,    _______,EN_S_N,  EN_S_M, EN_QUOT, XXXXXXX, AG_COLN,  AG_BSLS,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
                _______, _______,   _______, _______, _______,    _______, _______,   _______, _______,  _______
  //            \--------+--------+--------+---------+-------|   |--------+---------+--------+---------+-------/
),
/*
 * RU (base)
 * .-----------------------------------------.                    .-----------------------------------------.
 * | ESC  |  1   |  2   |  3   |  4   |  5   |                    |  6   |  7   |  8   |  9   |  0   |  -   |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * | PROG1|  й   |  ц   |  у   |  к   |  её  |                    |  н   |  г   |  ш   |  щ   |  з   |  х   |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * | ,+SPC|  ф   |  ы   |  в   |  а   |  п   |-------.    .-------|  р   |  о   |  л   |  д   |  ж   |  э   |
 * |------+------+------+------+------+------| HOME  |    |  END  |------+------+------+------+------+------|
 * | LANG |  я   |  ч   |  с   |  м   |  и   |-------|    |-------|  т   |  ьъ  |  б   |  ю   |  .   |  /   |
 * '-----------------------------------------/      /      \       \----------------------------------------'
 *            | WIN  | ALT  | CTRL | SPACE| /BSPACE/        \ ENTER \ | SHIFT| MOVE | TAB  | KEEB |
 *            '------+------+------+-------+-----/           \--------+------+------+------+------'
 */
  [L_RU] = LAYOUT(
  //,------------------------------------------------.                    ,---------------------------------------------------.
  KC_ESC,   AG_1,   AG_2,    AG_3,    AG_4,    AG_5,                       AG_6,    AG_7,   AG_8,   AG_9,    AG_0,    AG_MINS,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  _______,  RU_J,   RU_TS,   RU_U,    RU_K,    TD(D_EYO),                  RU_N,    RU_G,   RU_SH,  RU_SC,   RU_Z,    RU_H,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  AG_CMSP,  RU_F,   RU_Y,    RU_V,    RU_A,    RU_P,                       RU_R,    RU_O,   RU_L,   RU_D,    RU_ZH,   RU_E,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
  _______,  RU_JA,  RU_CH,   RU_S,    RU_M,    RU_I,  _______,   _______,  RU_T,   TD(D_SIGNS),RU_B,RU_JU,   AG_DOT,  AG_SLSH,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
                  _______,_______, _______,  _______, _______,    _______, _______,   _______, _______,  _______
  //            \--------+--------+--------+---------+-------|   |--------+---------+--------+---------+-------/
),
/*
 * RU (shifted)
 * .-----------------------------------------.                    .-----------------------------------------.
 * | ESC  |  !   |  "   |  #   |  $   |  %   |                    |  ^   |  ?   |  *   |  &   |  @   |  _   |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * | PROG1|  Й   |  Ц   |  У   |  К   |  ЕЁ  |                    |  Н   |  Г   |  Ш   |  Щ   |  З   |  Х   |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * |  ;   |  Ф   |  Ы   |  В   |  А   |  П   |-------.    .-------|  Р   |  О   |  Л   |  Д   |  Ж   |  Э   |
 * |------+------+------+------+------+------| HOME  |    |  END  |------+------+------+------+------+------|
 * | LANG |  Я   |  Ч   |  С   |  М   |  И   |-------|    |-------|  Т   |  ЬЪ  |  Б   |  Ю   |  :   |  \   |
 * '-----------------------------------------/      /      \       \----------------------------------------'
 *            | WIN  | ALT  | CTRL | SPACE| /BSPACE/        \ ENTER \ | SHIFT| MOVE | TAB  | KEEB |
 *            '------+------+------+------+------/           \--------+------+------+------+------'
 */
  [L_RU_S] = LAYOUT(

  //,------------------------------------------------.                    ,---------------------------------------------------.
  _______, AG_EXCL, AG_DQUO, EN_HASH,  EN_DLR, AG_PERC,                    EN_CIRC, AG_QUES,AG_ASTR, EN_AMPR, EN_AT,   AG_UNDS,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  _______,  RU_S_J, RU_S_TS, RU_S_U,   RU_S_K, TD(D_EYO),                  RU_S_N,  RU_S_G, RU_S_SH, RU_S_SC, RU_S_Z,  RU_S_H,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  AG_SCLN,  RU_S_F, RU_S_Y,  RU_S_V,   RU_S_A, RU_S_P,                     RU_S_R,  RU_S_O, RU_S_L,  RU_S_D,  RU_S_ZH, RU_S_E,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
  _______,  RU_S_JA,RU_S_CH, RU_S_S,   RU_S_M, RU_S_I,_______,    _______, RU_S_T,TD(D_SIGNS),RU_S_B,RU_S_JU, AG_COLN, AG_BSLS,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
                _______, _______,   _______, _______, _______,    _______, _______,   _______, _______,  _______
  //            \--------+--------+--------+---------+-------|   |--------+---------+--------+---------+-------/
),
/*
 * MOVE
 * .-----------------------------------------.                    .-----------------------------------------.
 * |CANCEL|  F1  |  F2  |  F3  |  F4  |  F5  |                    |  F6  |  F7  |  F8  |  F9  |  F10 | —+SPC|
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * | PROG1|      |  +   |  <   |  {   |  [   |                    |  (   | HOME | PGUP |PGDOWN|  END | F11  |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * |  ,   |      |  =   |  >   |  }   |  ]   |-------.    .-------|  )   | LEFT |  UP  | DOWN | RIGHT| F12  |
 * |------+------+------+------+------+------| HOME  |    |  END  |------+------+------+------+------+------|
 * | CAPS |      |  ~   |  `   |   '  |  |   |-------|    |-------| SNAP |C(LFT)| C(UP)| C(DN)|C(RGT)| LOCK |
 * '-----------------------------------------/      /      \       \----------------------------------------'
 *            | WIN  | ALT  | CTRL | SPACE| /DELETE/        \ ENTER \ | SHIFT| MOVE |S(TAB)| KEEB |
 *            '------+------+------+------+------/           \--------+------+------+------+------'
 */
  [L_MOVE] = LAYOUT(
  //,------------------------------------------------.                    ,---------------------------------------------------.
  CANCEL,   KC_F1,   KC_F2,  KC_F3,   KC_F4,  KC_F5,                      KC_F6,   KC_F7,  KC_F8,   KC_F9,    KC_F10,  MDASH_SP,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  _______,  XXXXXXX, AG_PLUS,EN_LT,   EN_LCBR,EN_LBRC,                    EN_LPRN, KC_HOME,KC_PGUP, KC_PGDN,  KC_END,   KC_F11,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  AG_COMM,  XXXXXXX, AG_EQL, EN_GT,   EN_RCBR,EN_RBRC,                    EN_RPRN, KC_LEFT,KC_UP,   KC_DOWN,  KC_RIGHT, KC_F12,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
  CAPS_WORD,XXXXXXX,EN_TILD, EN_GRV,  EN_QUOT,EN_PIPE,_______,    _______,TD(D_SNAP),LCTL(KC_LEFT),LCTL(KC_UP),LCTL(KC_DOWN),LCTL(KC_RIGHT), XXXXXXX,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
                _______, _______,   _______, _______, KC_DELETE,  _______, _______,   _______, S(KC_TAB),  _______
  //            \--------+--------+--------+---------+-------|   |--------+---------+--------+---------+-------/
),
/*
 * PROG
 * .-----------------------------------------.                    .-----------------------------------------.
 * |CANCEL|CAS(1)|CAS(2)|CAS(3)|CAS(4)|ALT+F4|                    |CAS(6)|CAS(7)|CAS(8)|CAS(9)|CAS(0)|      |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * | PROG1|CAS(Q)|CAS(W)|CAS(E)|ALTTAB|CAS(T)|                    |      | MUTE | VOL+ |CAS(O)| VOL2+|      |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * |      |CAS(A)|CAS(S)|CAS(D)|CAS(F)|CAS(G)|-------.    .-------|  UP  | PREV | PAUSE| NEXT | VOL2-|      |
 * |------+------+------+------+------+------| PAUSE |    | MUTE  |------+------+------+------+------+------|
 * |      |CAS(Z)|CAS(X)|CAS(C)|CAS(V)|CAS(B)|-------|    |-------| DOWN |CAS(M)| VOL- |      |      | LOCK |
 * '-----------------------------------------/      /      \       \----------------------------------------'
 *            | WIN  | ALT  | CTRL | SPACE| /BSPACE/        \ ENTER \ | SHIFT| MOVE | TAB  | KEEB |
 *            '------+------+------+------+------/           \--------+------+------+------+------'
 */
  [L_PROG] = LAYOUT(
  //,------------------------------------------------.                    ,---------------------------------------------------.
  _______,CASH(KC_1),CASH(KC_2),CASH(KC_3),CASH(KC_4),LALT(KC_F4),         CASH(KC_6),CASH(KC_7),CASH(KC_8),CASH(KC_9),CASH(KC_0),XXXXXXX,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  _______,CASH(KC_Q),CASH(KC_W),CASH(KC_E),LALT(KC_TAB),CASH(KC_T),       XXXXXXX,KC_AUDIO_MUTE,KC_AUDIO_VOL_UP,CASH(KC_O),KC_P8,XXXXXXX,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
XXXXXXX,CASH(KC_A),CASH(KC_S),CASH(KC_D),CASH(KC_F),CASH(KC_G),           KC_UP,KC_MEDIA_PREV_TRACK,KC_MEDIA_PLAY_PAUSE,KC_MEDIA_NEXT_TRACK,  KC_P2, XXXXXXX,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
XXXXXXX,CASH(KC_Z),CASH(KC_X),CASH(KC_C),CASH(KC_V),CASH(KC_B),KC_MEDIA_PLAY_PAUSE, KC_AUDIO_MUTE,KC_DOWN,CASH(KC_M),KC_AUDIO_VOL_DOWN,XXXXXXX,XXXXXXX,LOCK,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
                _______, _______,   _______, _______, KC_BSPC,    _______, _______,   _______, KC_TAB,  _______
  //            \--------+--------+--------+---------+-------|   |--------+---------+--------+---------+-------/
),
/*
 * KEEB
 * .-----------------------------------------.                    .-----------------------------------------.
 * |CANCEL|      |      |      |      |COLOR |                    |      |      |      |      |      | BOOT |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * | PROG1|      |      |      |      |      |                    |      |LA_CPS|LA_ALS|LA_CTS|LA_WSP|      |
 * |------+------+------+------+------+------|                    |------+------+------+------+------+------|
 * |      |      |      |      |      |      |-------.    .-------|      |      |      |      |      |      |
 * |------+------+------+------+------+------| PAUSE |    |  MUTE |------+------+------+------+------+------|
 * |LASYNC|      |      |      |      |      |-------|    |-------|      |      |      |      |      | LOCK |
 * '-----------------------------------------/      /      \       \----------------------------------------'
 *            | WIN  | ALT  | CTRL | SPACE| /BSPACE/        \ ENTER \ | SHIFT| MOVE | TAB  | KEEB |
 *            '------+------+------+------+------/           \--------+------+------+------+------'
 */
  [L_KEEB] = LAYOUT(
  //,------------------------------------------------.                    ,---------------------------------------------------.
  _______,  XXXXXXX,XXXXXXX,XXXXXXX,XXXXXXX,  RGB_TOG,           XXXXXXX, XXXXXXX,XXXXXXX,XXXXXXX,  XXXXXXX,  QK_BOOT,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  _______,  XXXXXXX,XXXXXXX,XXXXXXX,  XXXXXXX,XXXXXXX,                    XXXXXXX,  LA_CAPS, LA_SHAL,LA_SHCT,LA_WISP,  XXXXXXX,
  //|------+-------+--------+--------+--------+------|                   |--------+-------+--------+--------+--------+---------|
  XXXXXXX,  XXXXXXX,XXXXXXX, XXXXXXX, XXXXXXX,XXXXXXX,                    XXXXXXX,  XXXXXXX, XXXXXXX, XXXXXXX,XXXXXXX, XXXXXXX,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
  LA_SYNC,  XXXXXXX,XXXXXXX, XXXXXXX, XXXXXXX,XXXXXXX,_______,    _______,XXXXXXX,  XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, LOCK,
  //|------+-------+--------+--------+--------+------|  ===  |   |  ===  |--------+-------+--------+--------+--------+---------|
                  _______, _______,  _______, _______,_______,    _______, _______,   _______, _______,  _______
  //            \--------+--------+--------+---------+-------|   |--------+---------+--------+---------+-------/
),
};

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
    if (!lang_shift_process_record(keycode, record)) {
        return false;
    } 

    switch (keycode) {
     case CANCEL:
    if (record->event.pressed) {
      layer_move(IS_LAYER_ON(L_RU)?L_RU:L_EN);
    }
    return false;
        case LOCK:
    if (record->event.pressed) {
      SEND_STRING(SS_LGUI(SS_TAP(X_L)));
      if(IS_LAYER_ON(L_RU)) {
        keyrecord_t record;
        record.event.pressed = true;
        lang_shift_process_record(LA_CHNG, &record);
      }
      layer_move(L_EN);
    }
    return false;   
        case MDASH_SP: // ComposeKey - - - Space 
      if (record->event.pressed) {
        tap_code(COMPOSE_KEY);
        tap_code(KC_MINS);
        tap_code(KC_MINS);
        tap_code(KC_MINS);
        tap_code(KC_SPACE);
      }
      return false;
    }
    return true;
}

void user_timer(void) {
  lang_shift_user_timer();
}

void matrix_scan_user(void) {
  user_timer();
}

#ifdef CONSOLE_ENABLE
void keyboard_post_init_user(void) {
  debug_enable=true;
  //debug_matrix=true;
  //debug_keyboard=true;
  //debug_mouse=true;
}
#endif // CONSOLE_ENABLE